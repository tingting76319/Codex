name: Build macOS DMG

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: "Build target architecture"
        required: true
        default: "universal"
        type: choice
        options:
          - universal
          - arm64
          - x64
      notarize:
        description: "Enable notarization (requires secrets)"
        required: true
        default: true
        type: boolean
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-14
    permissions:
      contents: write
    env:
      CSC_LINK: ${{ secrets.MACOS_CERT_P12_BASE64 }}
      CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify tag matches package.json version (tag builds only)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: npm run release:verify-tag
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Import signing certificate
        if: ${{ env.CSC_LINK != '' }}
        shell: bash
        run: |
          echo "$CSC_LINK" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CSC_KEY_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Disable notarization for this run (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.notarize == false }}
        shell: bash
        run: |
          echo "APPLE_ID=" >> $GITHUB_ENV
          echo "APPLE_APP_SPECIFIC_PASSWORD=" >> $GITHUB_ENV
          echo "APPLE_TEAM_ID=" >> $GITHUB_ENV

      - name: Build universal
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.target_arch == 'universal') }}
        run: npm run dist:mac:universal

      - name: Build arm64
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.target_arch == 'arm64' }}
        run: npm run dist:mac:arm64

      - name: Build x64
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.target_arch == 'x64' }}
        run: npm run dist:mac:x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            dist/*.dmg
            dist/*.blockmap

      - name: Create GitHub Release (tag only)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.blockmap
